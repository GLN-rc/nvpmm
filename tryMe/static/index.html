<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>tryMe â€” Interactive Demo Builder</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <style>
        body { min-height: 100vh; }

        /* â”€â”€ Top nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .topnav {
            display: flex; align-items: center; justify-content: space-between;
            padding: 16px 32px;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border-light);
        }
        .topnav-logo {
            display: flex; align-items: center; gap: 10px;
            font-size: 20px; font-weight: 800; color: var(--text-primary);
            letter-spacing: -0.5px;
        }
        .topnav-logo .logo-icon {
            width: 32px; height: 32px; border-radius: 8px;
            background: var(--brand-primary);
            display: flex; align-items: center; justify-content: center;
            font-size: 18px;
        }
        .topnav-logo span.try { color: var(--brand-light); }
        .topnav-logo span.me  { color: var(--text-primary); }

        /* â”€â”€ Page body â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .page { max-width: 1080px; margin: 0 auto; padding: 40px 24px; }

        .page-header {
            display: flex; align-items: flex-start; justify-content: space-between;
            margin-bottom: 36px; gap: 16px; flex-wrap: wrap;
        }
        .page-header h1 { font-size: 26px; font-weight: 800; letter-spacing: -0.5px; }
        .page-header p  { font-size: 14px; color: var(--text-muted); margin-top: 4px; }

        /* â”€â”€ Demo grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #demo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .demo-card {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: var(--radius);
            padding: 22px;
            display: flex; flex-direction: column; gap: 12px;
            transition: var(--transition);
            cursor: default;
        }
        .demo-card:hover {
            border-color: rgba(108,92,231,0.4);
            box-shadow: 0 4px 20px rgba(108,92,231,0.15);
        }
        .demo-card-title {
            font-size: 16px; font-weight: 700; color: var(--text-primary);
            line-height: 1.3;
        }
        .demo-card-desc {
            font-size: 13px; color: var(--text-secondary);
            line-height: 1.5; flex: 1;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .demo-card-meta {
            display: flex; align-items: center; gap: 12px;
            font-size: 12px; color: var(--text-muted);
        }
        .demo-card-meta .step-count { display: flex; align-items: center; gap: 4px; }
        .demo-card-personas { display: flex; flex-wrap: wrap; gap: 5px; }
        .demo-card-personas .badge { font-size: 10px; padding: 2px 7px; }
        .demo-card-actions {
            display: flex; gap: 8px; margin-top: 4px;
        }
        .demo-card-actions .btn { flex: 1; justify-content: center; }

        /* â”€â”€ Loading skeleton â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .skeleton {
            background: linear-gradient(90deg, var(--bg-card) 25%, var(--bg-card-hover) 50%, var(--bg-card) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.4s infinite;
            border-radius: var(--radius-xs);
            height: 16px;
        }
        @keyframes shimmer { to { background-position: -200% 0; } }
    </style>
</head>
<body>

<!-- Nav -->
<nav class="topnav">
    <div class="topnav-logo">
        <div class="logo-icon">â–¶</div>
        <span class="try">try</span><span class="me">Me</span>
    </div>
    <div style="font-size:12px; color: var(--text-muted);">Interactive Demo Builder</div>
</nav>

<!-- Page -->
<div class="page">
    <div class="page-header">
        <div>
            <h1>Your Demos</h1>
            <p>Build self-guided, clickable product walkthroughs for any audience.</p>
        </div>
        <button class="btn btn-primary btn-lg" onclick="createDemo()">
            + New Demo
        </button>
    </div>

    <div id="demo-grid">
        <!-- populated by JS -->
    </div>
</div>

<!-- New Demo Modal -->
<div class="modal-overlay" id="new-demo-modal">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title">Create New Demo</div>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="field-group">
            <label>Demo Title *</label>
            <input type="text" id="new-title" placeholder="e.g. Onboarding Walkthrough for Sales Reps" autofocus>
        </div>
        <div class="field-group">
            <label>Description</label>
            <textarea id="new-desc" placeholder="What does this demo show? Who is it for?"></textarea>
        </div>
        <div class="field-group">
            <label>Target Personas <span style="font-weight:400; text-transform:none; letter-spacing:0; color:var(--text-muted);">(select all that apply)</span></label>
            <div class="persona-tags" id="new-personas">
                <!-- populated by JS -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="submitNewDemo()">Create Demo â†’</button>
        </div>
    </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
let selectedPersonas = new Set();
let allPersonas = [];

async function init() {
    await loadPersonas();
    await loadDemos();
}

async function loadPersonas() {
    const res = await fetch('/api/personas');
    const data = await res.json();
    allPersonas = data.personas;
}

async function loadDemos() {
    const grid = document.getElementById('demo-grid');
    grid.innerHTML = '<div style="grid-column:1/-1; padding:24px 0; color:var(--text-muted);">Loadingâ€¦</div>';
    const res = await fetch('/api/demos');
    const demos = await res.json();
    if (!demos.length) {
        grid.innerHTML = `
        <div class="empty-state" style="grid-column:1/-1">
            <div class="empty-icon">ğŸ¬</div>
            <h3>No demos yet</h3>
            <p>Create your first interactive product demo and share it with anyone â€” no signup required.</p>
            <button class="btn btn-primary" onclick="createDemo()">+ Create Your First Demo</button>
        </div>`;
        return;
    }
    grid.innerHTML = demos.map(renderDemoCard).join('');
}

function renderDemoCard(demo) {
    const personas = demo.personas || [];
    const personaBadges = personas.slice(0, 3).map(p =>
        `<span class="badge badge-purple">${esc(p)}</span>`
    ).join('') + (personas.length > 3 ? `<span class="badge badge-grey">+${personas.length-3}</span>` : '');
    const updatedAgo = timeAgo(demo.updated_at);
    return `
    <div class="demo-card">
        <div class="demo-card-title">${esc(demo.title)}</div>
        ${demo.description ? `<div class="demo-card-desc">${esc(demo.description)}</div>` : ''}
        <div class="demo-card-personas">${personaBadges || '<span style="color:var(--text-muted);font-size:12px;">No personas set</span>'}</div>
        <div class="demo-card-meta">
            <span class="step-count">ğŸ“¸ ${demo.step_count} step${demo.step_count !== 1 ? 's' : ''}</span>
            <span>Â· Updated ${updatedAgo}</span>
        </div>
        <div class="demo-card-actions">
            <a class="btn btn-secondary btn-sm" href="/editor/${demo.id}">âœï¸ Edit</a>
            <a class="btn btn-primary btn-sm" href="/demo/${demo.id}" target="_blank">â–¶ Preview</a>
            <button class="btn btn-ghost btn-sm" onclick="copyLink('${demo.id}')" title="Copy viewer link">ğŸ”—</button>
            <button class="btn btn-danger btn-sm" onclick="deleteDemo('${demo.id}', this)" title="Delete">ğŸ—‘</button>
        </div>
    </div>`;
}

function createDemo() {
    selectedPersonas.clear();
    document.getElementById('new-title').value = '';
    document.getElementById('new-desc').value = '';
    // Render persona tags
    const container = document.getElementById('new-personas');
    container.innerHTML = allPersonas.map(p => `
        <span class="persona-tag" onclick="togglePersona(this, '${esc(p)}')">${esc(p)}</span>
    `).join('');
    document.getElementById('new-demo-modal').classList.add('open');
    setTimeout(() => document.getElementById('new-title').focus(), 80);
}

function togglePersona(el, persona) {
    if (selectedPersonas.has(persona)) {
        selectedPersonas.delete(persona);
        el.classList.remove('selected');
    } else {
        selectedPersonas.add(persona);
        el.classList.add('selected');
    }
}

function closeModal() {
    document.getElementById('new-demo-modal').classList.remove('open');
}

async function submitNewDemo() {
    const title = document.getElementById('new-title').value.trim();
    if (!title) {
        document.getElementById('new-title').focus();
        return;
    }
    const desc = document.getElementById('new-desc').value.trim();
    const res = await fetch('/api/demos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, description: desc, personas: [...selectedPersonas] })
    });
    if (!res.ok) { showToast('Failed to create demo', 'error'); return; }
    const demo = await res.json();
    closeModal();
    window.location.href = `/editor/${demo.id}`;
}

async function deleteDemo(demoId, btn) {
    if (!confirm('Delete this demo and all its steps? This cannot be undone.')) return;
    btn.disabled = true;
    const res = await fetch(`/api/demos/${demoId}`, { method: 'DELETE' });
    if (res.ok) { showToast('Demo deleted', 'success'); loadDemos(); }
    else { showToast('Delete failed', 'error'); btn.disabled = false; }
}

function copyLink(demoId) {
    const url = `${location.origin}/demo/${demoId}`;
    navigator.clipboard.writeText(url).then(() => showToast('Link copied!', 'success'));
}

function showToast(msg, type = 'success') {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = `toast ${type} show`;
    setTimeout(() => t.classList.remove('show'), 2800);
}

function esc(s) {
    return (s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function timeAgo(ts) {
    const sec = Math.floor(Date.now()/1000 - ts);
    if (sec < 60) return 'just now';
    if (sec < 3600) return `${Math.floor(sec/60)}m ago`;
    if (sec < 86400) return `${Math.floor(sec/3600)}h ago`;
    return `${Math.floor(sec/86400)}d ago`;
}

// Enter key submits modal
document.addEventListener('keydown', e => {
    if (e.key === 'Enter' && document.getElementById('new-demo-modal').classList.contains('open')) {
        submitNewDemo();
    }
    if (e.key === 'Escape') closeModal();
});

init();
</script>
</body>
</html>
