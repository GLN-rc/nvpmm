name: Weekly Snapshot

on:
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
    concurrency:
      group: weekly-snapshot-${{ github.ref }}
      cancel-in-progress: true
    env:
      PYTHONUNBUFFERED: "1"
      # your secrets mapped to env for reuse
      OPENR_BASE: ${{ secrets.OPENR_BASE }}
      OPENR_API:  ${{ secrets.OPENR_API }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
      EMAIL_TO: ${{ secrets.EMAIL_TO }}
      EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}

    steps:
      - name: ðŸ”¹ Start â€” context & runner sanity
        run: |
          echo "Repo: $GITHUB_REPOSITORY"
          echo "Ref:  $GITHUB_REF"
          echo "SHA:  $GITHUB_SHA"
          echo "Runner: $RUNNER_OS / $RUNNER_ARCH"
          echo "Timestamp: $(date -u)"

      - name: ðŸ”¹ Checkout repo
        uses: actions/checkout@v4

      - name: ðŸ”¹ Preflight â€” required secrets present
        run: |
          ok=1
          for v in OPENR_BASE OPENR_API EMAIL_FROM EMAIL_TO EMAIL_PASSWORD; do
            if [ -z "${!v}" ]; then echo "âŒ Missing $v"; ok=0; else echo "âœ… $v set"; fi
          done
          if [ $ok -eq 0 ]; then echo "Secrets missing â†’ abort"; exit 1; fi

      - name: ðŸ”¹ Install dependencies
        run: |
          python -VV
          python -m pip install --upgrade pip
          python -m pip install "openai==0.28.1" litellm PyGithub requests python-dotenv
          python -c "import sys; print('site:', sys.path[0])"

      - name: ðŸ”¹ Locate weekly_snapshot2.py
        id: locate
        run: |
          echo "Tree (top-level):"; ls -la
          echo "Searching for weekly_snapshot2.py..."
          SCRIPT=$(git ls-files | grep -E '(^|/)(weekly[_-]?snapshot2)\.py$' | head -n1 || true)
          if [ -z "$SCRIPT" ]; then
            echo "âŒ Could not find weekly_snapshot2.py in repo"
            exit 1
          fi
          echo "âœ… Found: $SCRIPT"
          echo "script=$SCRIPT" >> "$GITHUB_OUTPUT"

      - name: ðŸ”¹ Run weekly snapshot (OpenRouter via LiteLLM)
        env:
          LLM_API_BASE: ${{ env.OPENR_BASE }}
          LLM_API_KEY:  ${{ env.OPENR_API }}
          MODEL: openrouter/auto
          MAX_TOKENS: "800"
          TEMP: "0.2"
          OUTPUT_HTML: report.html
          USE_OPENAI: "false"
          OPENAI_API_KEY: ${{ env.OPENAI_API_KEY }}
        run: |
          set -e
          echo "Running: ${{ steps.locate.outputs.script }}"
          python "${{ steps.locate.outputs.script }}" > report.html
          echo "Report size: $(wc -c < report.html) bytes"

      - name: ðŸ”¹ Upload report artifact
        uses: actions/upload-artifact@v4
        with:
          name: weekly-snapshot
          path: report.html

      - name: ðŸ”¹ Email report via Gmail (inline SMTP)
        env:
          EMAIL_FROM: ${{ env.EMAIL_FROM }}
          EMAIL_TO: ${{ env.EMAIL_TO }}
          EMAIL_PASSWORD: ${{ env.EMAIL_PASSWORD }}
        run: |
          python - <<'PY'
import os, sys, smtplib, ssl
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart

sender = os.environ.get("EMAIL_FROM")
recips = [e.strip() for e in os.environ.get("EMAIL_TO","").split(",") if e.strip()]
app_pw = os.environ.get("EMAIL_PASSWORD")

print("From:", sender)
print("To:", recips)
if not (sender and recips and app_pw):
    print("Missing EMAIL_FROM/EMAIL_TO/EMAIL_PASSWORD"); sys.exit(1)

with open("report.html","r",encoding="utf-8") as f:
    html = f.read()

msg = MIMEMultipart("alternative")
msg["Subject"] = "ReplicaRivals â€” Weekly Competitive Snapshot"
msg["From"] = sender
msg["To"] = ", ".join(recips)
msg.attach(MIMEText(html, "html", "utf-8"))

context = ssl.create_default_context()
with smtplib.SMTP("smtp.gmail.com", 587, timeout=60) as server:
    server.ehlo()
    server.starttls(context=context)
    server.ehlo()
    server.login(sender, app_pw)
    server.sendmail(sender, recips, msg.as_string())

print("âœ… Email sent.")
PY





#name: Weekly Snapshot
# 
#on:
#  workflow_dispatch:
#  schedule:
#    # Fridays during Daylight Time (EDT = UTC-4): 13:00 UTC == 09:00 ET
#    - cron: "0 9 * * FRI"
#    # Fridays during Standard Time (EST = UTC-5): 14:00 UTC == 09:00 ET
#    - cron: "0 14 * * FRI"
#
#jobs:
#  run:
#    runs-on: ubuntu-latest
#    permissions:
#      contents: read
#
#    steps:
#      - name: Checkout repo
#        uses: actions/checkout@v4
#
#      # Gate: only continue if it's Friday 09:00 in America/New_York
#      - name: Ensure it's 09:00 Friday in New York
#        run: |
#          ny_wday=$(TZ=America/New_York date +%u) # 5 = Friday
#          ny_hour=$(TZ=America/New_York date +%H) # 09 = 9am
#          echo "NY weekday=$ny_wday hour=$ny_hour"
#          if [ "$ny_wday" != "5" ] || [ "$ny_hour" != "09" ]; then
#            echo "Not 09:00 Friday in New Yorkâ€”exiting."
#            exit 0
#          fi
#
#      - name: Set up Python
#        uses: actions/setup-python@v5
#        with:
#          python-version: "3.12"
#
#      - name: Install dependencies
#        run: |
#          python -m pip install --upgrade pip
#          python -m pip install "openai==0.28.1" litellm PyGithub requests python-dotenv
#
#    - name: Run weekly snapshot
#      env:
#        # === LLM via LiteLLM (default path) ===
#        OPENR_API: ${{ secrets.OPENR_API }}
#        OPENR_BASE: ${{ secrets.OPENR_BASE }}
#        MODEL: openrouter/auto           # pick a model your provider supports; 'auto' is fine to start
#        MAX_TOKENS: "800"
#        TEMP: "0.2"
#        OUTPUT_HTML: report.html
#        SNAPSHOT_WINDOW_DAYS: "7"   
#      - name: Run weekly snapshot
#        env:
#          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
#          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#
#        
#        run: python weekly_snapshot2.py > report.htmk
#
#      - name: Upload report artifact (optional)
#        if: success()
#        uses: actions/upload-artifact@v4
#        with:
#          name: weekly-snapshot2
#          path: |
#            report.html
#            output/**
#          if-no-files-found: ignore
