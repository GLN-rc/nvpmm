name: Weekly Snapshot

on:
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read

    # Map your secrets to env once for reuse
    env:
      OPENR_BASE:       ${{ secrets.OPENR_BASE }}
      OPENR_API:        ${{ secrets.OPENR_API }}
      OPENAI_API_KEY:   ${{ secrets.OPENAI_API_KEY }}
      EMAIL_FROM:       ${{ secrets.EMAIL_FROM }}
      EMAIL_TO:         ${{ secrets.EMAIL_TO }}
      EMAIL_PASSWORD:   ${{ secrets.EMAIL_PASSWORD }}
      PYTHONUNBUFFERED: "1"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
      python -m pip install --upgrade pip
      python -m pip install feedparser python-dateutil PyYAML requests tldextract
    - name: Build report from feeds (free mode)
      env:
          OUTPUT_HTML: report.html
          NEWS_FEEDS_CONFIG: config/news_feeds.yaml
      run: |
        python build_report_from_feeds.py
        test -s report.html || (echo "Empty report.html"; exit 1)

- name: Verify report links and policy
  run: |
    python verify_report.py
#      - name: Install dependencies
#        run: |
#          python -m pip install --upgrade pip
#          python -m pip install "litellm==1.43.9" "httpx>=0.27,<0.28" PyYAML requests PyGithub python-dotenv
#          
#      - name: Run weekly snapshot (OpenRouter via LiteLLM)
#        env:
#          # Provider creds mapped to what the script expects
#          LLM_API_BASE: ${{ env.OPENR_BASE }}   # e.g. https://openrouter.ai/api/v1
#          LLM_API_KEY:  ${{ env.OPENR_API }}
#          MODEL: mistralai/mixtral-8x7b-instruct
#          MAX_TOKENS: "1500"
#          TEMP: "0.18"
#          OUTPUT_HTML: report.html
#          SNAPSHOT_CONFIG: config/company.yaml
#          EXTRA_NOTES: notes/weekly_signals.md
#          USE_OPENAI: "false"
#          OPENAI_API_KEY: ${{ env.OPENAI_API_KEY }}
#        run: |
#          python weekly_snapshot2.py > report.html
#          echo "Report size: $(wc -c < report.html) bytes"

      - name: Verify report isn't empty
        run: |
          if [ ! -s report.html ]; then
            echo "Empty report.html"
            exit 1
          fi

      - name: Verify report has real content
        run: |
          if grep -q '\[Placeholder\]' report.html; then
            echo "Report contains placeholders — generation failed"
            exit 1
          fi
      - name: Verify report links and policy
        run: |
          python verify_report.py

      - name: Upload report artifact
        uses: actions/upload-artifact@v4
        with:
          name: weekly-snapshot
          path: report.html

      - name: Email report via Gmail (App Password)
        env:
          EMAIL_FROM:     ${{ env.EMAIL_FROM }}       # full Gmail address
          EMAIL_TO:       ${{ env.EMAIL_TO }}         # comma-separated ok
          EMAIL_PASSWORD: ${{ env.EMAIL_PASSWORD }}   # 16-char app password
        run: |
          python send_email.py



#name: Weekly Snapshot
# 
#on:
#  workflow_dispatch:
#  schedule:
#    # Fridays during Daylight Time (EDT = UTC-4): 13:00 UTC == 09:00 ET
#    - cron: "0 9 * * FRI"
#    # Fridays during Standard Time (EST = UTC-5): 14:00 UTC == 09:00 ET
#    - cron: "0 14 * * FRI"
#
#jobs:
#  run:
#    runs-on: ubuntu-latest
#    permissions:
#      contents: read
#
#    steps:
#      - name: Checkout repo
#        uses: actions/checkout@v4
#
#      # Gate: only continue if it's Friday 09:00 in America/New_York
#      - name: Ensure it's 09:00 Friday in New York
#        run: |
#          ny_wday=$(TZ=America/New_York date +%u) # 5 = Friday
#          ny_hour=$(TZ=America/New_York date +%H) # 09 = 9am
#          echo "NY weekday=$ny_wday hour=$ny_hour"
#          if [ "$ny_wday" != "5" ] || [ "$ny_hour" != "09" ]; then
#            echo "Not 09:00 Friday in New York—exiting."
#            exit 0
#          fi
#
#      - name: Set up Python
#        uses: actions/setup-python@v5
#        with:
#          python-version: "3.12"
#
#      - name: Install dependencies
#        run: |
#          python -m pip install --upgrade pip
#          python -m pip install "openai==0.28.1" litellm PyGithub requests python-dotenv
#
#    - name: Run weekly snapshot
#      env:
#        # === LLM via LiteLLM (default path) ===
#        OPENR_API: ${{ secrets.OPENR_API }}
#        OPENR_BASE: ${{ secrets.OPENR_BASE }}
#        MODEL: openrouter/auto           # pick a model your provider supports; 'auto' is fine to start
#        MAX_TOKENS: "800"
#        TEMP: "0.2"
#        OUTPUT_HTML: report.html
#        SNAPSHOT_WINDOW_DAYS: "7"   
#      - name: Run weekly snapshot
#        env:
#          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
#          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#
#        
#        run: python weekly_snapshot2.py > report.htmk
#
#      - name: Upload report artifact (optional)
#        if: success()
#        uses: actions/upload-artifact@v4
#        with:
#          name: weekly-snapshot2
#          path: |
#            report.html
#            output/**
#          if-no-files-found: ignore
